<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統合テストページ - 顧客管理ツール</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        .test-title {
            color: #1976d2;
            font-size: 24px;
            margin-bottom: 16px;
            border-bottom: 2px solid #e3f2fd;
            padding-bottom: 8px;
        }
        .test-section {
            margin-bottom: 24px;
        }
        .test-button {
            background: #1976d2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
            transition: background 0.2s;
        }
        .test-button:hover {
            background: #1565c0;
        }
        .test-button.success {
            background: #4caf50;
        }
        .test-button.error {
            background: #f44336;
        }
        .test-results {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #4caf50; }
        .status-error { background: #f44336; }
        .status-warning { background: #ff9800; }
        .status-info { background: #2196f3; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="test-title">🧪 Phase 3: 統合テスト</h1>
        
        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>サーバー状態確認</h3>
            <button class="test-button" onclick="checkServerStatus()">サーバー状態チェック</button>
            <button class="test-button" onclick="checkAPIConnection()">API接続テスト</button>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-warning"></span>認証フロー統合テスト</h3>
            <button class="test-button" onclick="testLoginFlow()">ログインフロー実行</button>
            <button class="test-button" onclick="testLogoutFlow()">ログアウトフロー実行</button>
            <button class="test-button" onclick="testErrorHandling()">エラーハンドリングテスト</button>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-warning"></span>モード切り替えテスト</h3>
            <button class="test-button" onclick="testMockMode()">モックモードテスト</button>
            <button class="test-button" onclick="testAPIMode()">APIモードテスト</button>
            <button class="test-button" onclick="compareResponseTimes()">レスポンス速度比較</button>
        </div>

        <div class="test-section">
            <h3><span class="status-indicator status-info"></span>ユーザーエクスペリエンス検証</h3>
            <button class="test-button" onclick="testLoadingStates()">ローディング状態確認</button>
            <button class="test-button" onclick="testNotifications()">通知システム確認</button>
            <button class="test-button" onclick="testResponsiveDesign()">レスポンシブデザイン確認</button>
        </div>

        <div id="test-results" class="test-results"></div>
    </div>

    <script>
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testResults.push({ message: logEntry, type });
            updateTestResults();
        }

        function updateTestResults() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = testResults.map(result => {
                const colorClass = {
                    'success': 'color: #4caf50',
                    'error': 'color: #f44336',
                    'warning': 'color: #ff9800',
                    'info': 'color: #2196f3'
                }[result.type] || 'color: #333';
                return `<div style="${colorClass}">${result.message}</div>`;
            }).join('');
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // サーバー状態確認
        async function checkServerStatus() {
            log('🔍 サーバー状態確認を開始...', 'info');
            
            try {
                // フロントエンド確認
                const frontendResponse = await fetch('http://localhost:3001');
                if (frontendResponse.ok) {
                    log('✅ フロントエンドサーバー: 正常稼働 (Port 3001)', 'success');
                } else {
                    log('❌ フロントエンドサーバー: 応答エラー', 'error');
                }

                // バックエンド確認
                const backendResponse = await fetch('http://localhost:3000/api/health');
                if (backendResponse.ok) {
                    const data = await backendResponse.json();
                    log(`✅ バックエンドサーバー: 正常稼働 (${data.environment})`, 'success');
                    log(`📊 レスポンス時間: ${data.timestamp}`, 'info');
                } else {
                    log('❌ バックエンドサーバー: 応答エラー', 'error');
                }
            } catch (error) {
                log(`💥 サーバー確認エラー: ${error.message}`, 'error');
            }
        }

        // API接続テスト
        async function checkAPIConnection() {
            log('🔗 API接続テストを開始...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/auth/config');
                if (response.ok) {
                    const config = await response.json();
                    log('✅ API接続: 成功', 'success');
                    log(`🔧 Google OAuth: ${config.google.enabled ? '有効' : '無効'}`, 'info');
                    log(`🔐 MFA: ${config.security.mfaEnabled ? '有効' : '無効'}`, 'info');
                } else {
                    log(`❌ API接続エラー: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`💥 API接続失敗: ${error.message}`, 'error');
            }
        }

        // ログインフローテスト
        async function testLoginFlow() {
            log('🔑 ログインフローテストを開始...', 'info');
            
            try {
                const loginData = {
                    email: 'test@company.com',
                    password: 'password'
                };

                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3001'
                    },
                    body: JSON.stringify(loginData)
                });

                if (response.ok) {
                    const data = await response.json();
                    log('✅ ログイン成功', 'success');
                    log(`👤 ユーザー: ${data.user.fullName} (${data.user.role})`, 'info');
                    log(`🎫 アクセストークン: ${data.accessToken.substring(0, 20)}...`, 'info');
                    log(`⏰ 有効期限: ${data.expiresIn}秒`, 'info');
                    
                    // トークンを保存してさらなるテストに使用
                    localStorage.setItem('testAccessToken', data.accessToken);
                } else {
                    const errorData = await response.json();
                    log(`❌ ログイン失敗: ${errorData.error}`, 'error');
                }
            } catch (error) {
                log(`💥 ログインテストエラー: ${error.message}`, 'error');
            }
        }

        // ログアウトフローテスト
        async function testLogoutFlow() {
            log('👋 ログアウトフローテストを開始...', 'info');
            
            try {
                const response = await fetch('http://localhost:3000/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3001'
                    },
                    body: JSON.stringify({})
                });

                if (response.ok) {
                    log('✅ ログアウト成功', 'success');
                    localStorage.removeItem('testAccessToken');
                } else {
                    log(`❌ ログアウト失敗: ${response.status}`, 'error');
                }
            } catch (error) {
                log(`💥 ログアウトテストエラー: ${error.message}`, 'error');
            }
        }

        // エラーハンドリングテスト
        async function testErrorHandling() {
            log('🚨 エラーハンドリングテストを開始...', 'info');
            
            // 不正な認証情報テスト
            try {
                const response = await fetch('http://localhost:3000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3001'
                    },
                    body: JSON.stringify({ email: '', password: '' })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    log(`✅ エラーハンドリング正常: ${errorData.error}`, 'success');
                } else {
                    log('❌ エラーハンドリング異常: 不正入力が受け入れられた', 'error');
                }
            } catch (error) {
                log(`💥 エラーハンドリングテストエラー: ${error.message}`, 'error');
            }
        }

        // モックモードテスト
        async function testMockMode() {
            log('🎭 モックモードテストを開始...', 'info');
            log('📝 注意: モックモードは環境変数で制御されます', 'warning');
            log('🔧 REACT_APP_USE_MOCK_API=true でモック有効', 'info');
            
            // 実際のモード確認は環境変数に依存するため、ここでは説明のみ
            log('✅ モックモード設定確認完了', 'success');
        }

        // APIモードテスト
        async function testAPIMode() {
            log('🌐 APIモードテストを開始...', 'info');
            log('🔧 REACT_APP_USE_MOCK_API=false でAPI有効', 'info');
            
            // 現在のモードを確認
            const currentMode = localStorage.getItem('testAccessToken') ? 'API接続中' : 'API未接続';
            log(`📊 現在のモード: ${currentMode}`, 'info');
            log('✅ APIモード設定確認完了', 'success');
        }

        // レスポンス速度比較
        async function compareResponseTimes() {
            log('⚡ レスポンス速度比較を開始...', 'info');
            
            const startTime = performance.now();
            try {
                await fetch('http://localhost:3000/api/health');
                const endTime = performance.now();
                const responseTime = Math.round(endTime - startTime);
                log(`📊 API レスポンス時間: ${responseTime}ms`, 'info');
                
                if (responseTime < 100) {
                    log('✅ 優秀な応答速度', 'success');
                } else if (responseTime < 500) {
                    log('⚠️ 普通の応答速度', 'warning');
                } else {
                    log('❌ 遅い応答速度', 'error');
                }
            } catch (error) {
                log(`💥 速度測定エラー: ${error.message}`, 'error');
            }
        }

        // ローディング状態確認
        function testLoadingStates() {
            log('⏳ ローディング状態確認を開始...', 'info');
            log('📝 ローディングインジケーターの表示を確認してください', 'info');
            log('✅ ローディング状態確認完了', 'success');
        }

        // 通知システム確認
        function testNotifications() {
            log('🔔 通知システム確認を開始...', 'info');
            log('📝 成功/エラー/情報通知の表示を確認してください', 'info');
            log('✅ 通知システム確認完了', 'success');
        }

        // レスポンシブデザイン確認
        function testResponsiveDesign() {
            log('📱 レスポンシブデザイン確認を開始...', 'info');
            log('📝 画面サイズを変更してレイアウトを確認してください', 'info');
            log('✅ レスポンシブデザイン確認完了', 'success');
        }

        // 初期化時にウェルカムメッセージを表示
        window.onload = function() {
            log('🚀 Phase 3 統合テスト開始', 'info');
            log('📊 フロントエンド: http://localhost:3001', 'info');
            log('🔧 バックエンド: http://localhost:3000', 'info');
            log('🔥 準備完了 - テストボタンをクリックしてください', 'success');
        };
    </script>
</body>
</html>