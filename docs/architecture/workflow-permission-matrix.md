# 最強タスク管理ツール - ワークフロー権限マトリックス

## 🎯 権限設計の基本原則

**設計日**: 2025-07-30  
**設計者**: ★4 アーキテクチャデザイナー

### 核心設計方針
1. **個人ワークフロー完全自由**: 個人レベルでの最大カスタマイズ自由度
2. **共有タスク適切制御**: 共有タスクでの承認フロー・権限制御
3. **企業データ完全分離**: 企業間データ漏洩防止の完全分離
4. **プライバシー優先**: ユーザー個人設定の厳格保護

## 📊 権限マトリックス詳細設計

### 1. ワークフローテンプレート操作権限

| 操作 | USER | TEAM_LEADER | MANAGER | COMPANY_LEADER |
|------|------|-------------|---------|----------------|
| **個人ワークフロー作成** | ✅ 無制限 | ✅ 無制限 | ✅ 無制限 | ✅ 無制限 |
| **個人ワークフロー編集** | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ |
| **個人ワークフロー削除** | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ |
| **チームワークフロー作成** | ❌ | ✅ 担当チーム | ✅ 担当部門 | ✅ 全社 |
| **チームワークフロー編集** | ❌ | ✅ 担当チーム | ✅ 担当部門 | ✅ 全社 |
| **チームワークフロー削除** | ❌ | ⚠️ 承認必要 | ✅ 担当部門 | ✅ 全社 |
| **企業ワークフロー作成** | ❌ | ❌ | ⚠️ 承認必要 | ✅ |
| **企業ワークフロー編集** | ❌ | ❌ | ⚠️ 承認必要 | ✅ |
| **企業ワークフロー削除** | ❌ | ❌ | ❌ | ✅ |

### 2. ステータス遷移・承認権限

| ステータス遷移 | USER | TEAM_LEADER | MANAGER | COMPANY_LEADER |
|----------------|------|-------------|---------|----------------|
| **基本ステータス遷移** | ✅ 自分のタスク | ✅ 自分のタスク | ✅ 自分のタスク | ✅ 自分のタスク |
| **承認待ち→承認済み** | ❌ | ✅ 担当チーム | ✅ 担当部門 | ✅ 全社 |
| **承認済み→差し戻し** | ❌ | ✅ 承認者のみ | ✅ 承認者のみ | ✅ 承認者のみ |
| **返信待ち→対応中** | ✅ 担当者のみ | ✅ 担当者・上位 | ✅ 担当者・上位 | ✅ 担当者・上位 |
| **顧客確認中→完了** | ✅ 担当者のみ | ✅ 担当者・上位 | ✅ 担当者・上位 | ✅ 担当者・上位 |
| **緊急オーバーライド** | ❌ | ❌ | ⚠️ 理由記録必須 | ✅ |

### 3. カスタムステータス・工数テンプレート管理

| 機能 | USER | TEAM_LEADER | MANAGER | COMPANY_LEADER |
|------|------|-------------|---------|----------------|
| **個人カスタムステータス作成** | ✅ 無制限 | ✅ 無制限 | ✅ 無制限 | ✅ 無制限 |
| **チーム用カスタムステータス** | ❌ | ✅ 承認フロー | ✅ 承認フロー | ✅ |
| **企業標準ステータス定義** | ❌ | ❌ | ⚠️ 承認必要 | ✅ |
| **個人工数テンプレート** | ✅ 無制限 | ✅ 無制限 | ✅ 無制限 | ✅ 無制限 |
| **共有工数テンプレート** | ❌ | ✅ 担当チーム | ✅ 担当部門 | ✅ 全社 |
| **工数テンプレート統計閲覧** | ✅ 自分のみ | ✅ 担当チーム | ✅ 担当部門 | ✅ 全社 |

### 4. データ閲覧・共有権限

| データ範囲 | USER | TEAM_LEADER | MANAGER | COMPANY_LEADER |
|------------|------|-------------|---------|----------------|
| **個人ワークフロー閲覧** | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ |
| **チームワークフロー閲覧** | ⚠️ 所属チームのみ | ✅ 担当チーム | ✅ 担当部門 | ✅ 全社 |
| **企業ワークフロー閲覧** | ✅ 公開のみ | ✅ 公開のみ | ✅ 担当部門 | ✅ 全社 |
| **工数レポート閲覧** | ❌ | ✅ 担当チーム | ✅ 担当部門 | ✅ 全社 |
| **プライバシー設定管理** | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ | ✅ 自分のみ |

## 🔐 スコープ別権限詳細

### PERSONAL スコープ（個人ワークフロー）
- **完全プライベート**: 他のユーザーから完全に隠蔽
- **自由度最大**: 無制限カスタマイズ・ステータス作成可能
- **制約なし**: 承認フロー・権限チェック一切なし
- **データ保護**: 企業管理者でも閲覧・変更不可

### TEAM スコープ（チームワークフロー）
- **チーム内共有**: 同じチームメンバー間で共有
- **承認制適用**: ワークフロー変更時は承認フロー必須
- **TEAM_LEADER権限**: チーム専用ワークフロー管理権限
- **相互監視**: チームメンバー間でのワークフロー使用状況可視化

### DEPARTMENT スコープ（部門ワークフロー）
- **部門内統制**: MANAGER以上による部門ワークフロー管理
- **標準化促進**: 部門共通プロセスの標準ワークフロー提供
- **効率性重視**: 部門全体の業務効率向上を目指した設計

### COMPANY スコープ（企業ワークフロー）
- **全社統制**: COMPANY_LEADER による全社ワークフロー管理
- **コンプライアンス**: 企業規定に準拠したワークフロー強制適用
- **監査対応**: 全社レベルでの業務プロセス監査・記録

## ⚠️ 特別権限・緊急対応

### 緊急オーバーライド機能
- **対象**: MANAGER以上
- **条件**: システム障害・緊急業務対応時のみ
- **記録**: 全ての緊急操作は監査ログに詳細記録
- **承認**: COMPANY_LEADERによる事後承認必須

### 承認タイムアウト処理
- **自動エスカレーション**: 48時間未承認時に上位権限者へ自動転送
- **最終承認者**: COMPANY_LEADERが最終承認者
- **業務継続**: タイムアウト時も業務停止防止の代替フロー

## 🛡️ セキュリティ制約

### データ分離原則
1. **企業間完全分離**: companyId必須、他企業データ一切アクセス不可
2. **ユーザーレベル分離**: 個人ワークフローは完全プライベート
3. **権限継承制限**: 上位権限でも個人データ改変不可

### プライバシー保護
1. **設定選択権**: ユーザーが共有レベルを選択可能
2. **透明性確保**: データアクセス状況をユーザーに通知
3. **匿名化オプション**: 統計データでは個人特定情報除去

## 📋 API エンドポイント権限マッピング

### ワークフローテンプレート API
```typescript
GET /api/workflows/templates          // 閲覧権限: 所属スコープ内
POST /api/workflows/templates         // 作成権限: スコープ別権限チェック
PUT /api/workflows/templates/:id      // 編集権限: 作成者または上位権限
DELETE /api/workflows/templates/:id   // 削除権限: MANAGER以上（個人除く）
```

### ワークフロー設定 API
```typescript
GET /api/workflows/settings           // 個人設定: 本人のみ
PUT /api/workflows/settings           // 個人設定: 本人のみ
GET /api/workflows/settings/user/:id  // 他人設定: TEAM_LEADER以上
PUT /api/workflows/settings/user/:id  // 他人設定: MANAGER以上
```

### 工数テンプレート API
```typescript
GET /api/workflows/effort-templates   // 閲覧権限: 所属スコープ内
POST /api/workflows/effort-templates  // 作成権限: TEAM_LEADER以上
PUT /api/workflows/effort-templates/:id   // 編集権限: 作成者または上位権限
DELETE /api/workflows/effort-templates/:id // 削除権限: MANAGER以上
```

## 🔄 権限チェック実装指針

### JWT トークン拡張
```typescript
interface WorkflowJWTPayload extends JWTPayload {
  workflowPermissions: WorkflowPermission[];
  workflowScopes: string[];
  teamIds: ID[];
  departmentIds: ID[];
}
```

### 権限チェック関数
```typescript
function checkWorkflowPermission(
  user: User,
  action: WorkflowPermission,
  targetResource: WorkflowTemplate | EffortTemplate,
  context: { teamId?: ID; departmentId?: ID }
): boolean
```

### ミドルウェア構成
1. **認証ミドルウェア**: JWT検証・ユーザー情報取得
2. **権限チェックミドルウェア**: ワークフロー操作権限検証
3. **スコープ検証ミドルウェア**: データアクセススコープ検証
4. **監査ログミドルウェア**: 全操作の記録・追跡

---

**次フェーズ**: ★8バックエンド実装エージェントは、この権限マトリックスに基づいてワークフロー管理APIを実装してください。